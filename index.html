// <!-- Evento para el botón "Descargar PDF" -->
            downloadBtn.addEventListener('click', async function() {
                loader.classList.remove('hidden');
                downloadBtn.classList.add('hidden');
                backBtn.classList.add('hidden');

                const currentScrollPos = window.pageYOffset;
                
                // Ocultamos resultados y mostramos formulario temporalmente
                resultsPage.classList.add('hidden');
                formPage.classList.remove('hidden');
                
                // Ocultamos el botón de calcular para el PDF
                const calculateBtnContainer = document.getElementById('calculateButtonContainer');
                calculateBtnContainer.style.display = 'none';

                // Esperamos un momento para que el DOM se actualice
                await new Promise(resolve => setTimeout(resolve, 200));

                try {
                    const options = {
                        scale: 3,
                        useCORS: true,
                        allowTaint: false,
                        backgroundColor: '#ffffff',
                        logging: false,
                        onclone: (documentClone) => {
                            const clonedContent = documentClone.getElementById('form-content');
                            const form = document.getElementById('fiscalizacionForm');
                            const clonedForm = documentClone.getElementById('fiscalizacionForm');
                            
                            if (!form || !clonedForm) {
                                console.error("No se pudo encontrar el formulario.");
                                return;
                            }

                            // Aplicar estilos para mejorar renderizado
                            const style = documentClone.createElement('style');
                            style.textContent = `
                                * { -webkit-print-color-adjust: exact !important; color-adjust: exact !important; }
                                input, textarea, select { 
                                    border: 1px solid #9ca3af !important;
                                    padding: 8px !important;
                                    line-height: 1.5 !important;
                                    min-height: 38px !important;
                                }
                                input[type="text"], input[type="date"], input[type="time"], input[type="number"] {
                                    display: block !important;
                                    width: 100% !important;
                                }
                                textarea {
                                    display: block !important;
                                    width: 100% !important;
                                    min-height: 80px !important;
                                }
                            `;
                            documentClone.head.appendChild(style);

                            // Copiar valores y crear divs visibles con el texto
                            const textInputs = form.querySelectorAll('input[type="text"], input[type="date"], input[type="time"], input[type="number"]');
                            const clonedTextInputs = clonedForm.querySelectorAll('input[type="text"], input[type="date"], input[type="time"], input[type="number"]');
                            textInputs.forEach((input, index) => {
                                if (clonedTextInputs[index] && input.value) {
                                    clonedTextInputs[index].value = input.value;
                                    clonedTextInputs[index].setAttribute('value', input.value);
                                    // Crear un div visible con el valor
                                    const valueDiv = documentClone.createElement('div');
                                    valueDiv.textContent = input.value;
                                    valueDiv.style.cssText = 'position: absolute; padding: 8px; pointer-events: none; background: white; width: 100%; box-sizing: border-box;';
                                    clonedTextInputs[index].parentNode.style.position = 'relative';
                                    clonedTextInputs[index].parentNode.appendChild(valueDiv);
                                }
                            });
                            
                            const textareas = form.querySelectorAll('textarea');
                            const clonedTextareas = clonedForm.querySelectorAll('textarea');
                            textareas.forEach((textarea, index) => {
                                if (clonedTextareas[index] && textarea.value) {
                                    clonedTextareas[index].value = textarea.value;
                                    clonedTextareas[index].textContent = textarea.value;
                                    // Crear un div visible con el valor
                                    const valueDiv = documentClone.createElement('div');
                                    valueDiv.textContent = textarea.value;
                                    valueDiv.style.cssText = 'position: absolute; padding: 8px; pointer-events: none; background: white; width: 100%; min-height: 80px; white-space: pre-wrap; box-sizing: border-box;';
                                    clonedTextareas[index].parentNode.style.position = 'relative';
                                    clonedTextareas[index].parentNode.appendChild(valueDiv);
                                }
                            });

                            const checkboxes = form.querySelectorAll('input[type="checkbox"]');
                            const clonedCheckboxes = clonedForm.querySelectorAll('input[type="checkbox"]');
                            checkboxes.forEach((checkbox, index) => {
                                if (clonedCheckboxes[index]) clonedCheckboxes[index].checked = checkbox.checked;
                            });

                            const radios = form.querySelectorAll('input[type="radio"]');
                            const clonedRadios = clonedForm.querySelectorAll('input[type="radio"]');
                            radios.forEach((radio, index) => {
                                if (clonedRadios[index]) clonedRadios[index].checked = radio.checked;
                            });
                        }
                    };
                    
                    // Capturar formulario
                    const formCanvas = await html2canvas(formContent, options);
                    
                    if (formCanvas.width === 0 || formCanvas.height === 0) {
                        throw new Error('Canvas del formulario vacío');
                    }

                    // Ahora capturar la página de resultados
                    formPage.classList.add('hidden');
                    resultsPage.classList.remove('hidden');
                    
                    await new Promise(resolve => setTimeout(resolve, 200));
                    
                    const resultsBox = document.getElementById('results-box');
                    const resultsCanvas = await html2canvas(resultsBox, options);

                    // Crear PDF
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    
                    const margin = 10;
                    const pageWidth = pdf.internal.pageSize.getWidth();
                    const pageHeight = pdf.internal.pageSize.getHeight();
                    const contentWidth = pageWidth - (margin * 2);
                    const contentHeight = pageHeight - (margin * 2);

                    // Agregar formulario
                    const formImgData = formCanvas.toDataURL('image/jpeg', 0.95);
                    const formRatio = contentWidth / formCanvas.width;
                    const formScaledHeight = formCanvas.height * formRatio;
                    
                    let yOffset = 0;
                    let pageCount = 0;
                    
                    while (yOffset < formScaledHeight) {
                        if (pageCount > 0) {
                            pdf.addPage();
                        }
                        
                        const sourceY = yOffset / formRatio;
                        const sourceHeight = Math.min(contentHeight / formRatio, formCanvas.height - sourceY);
                        const destHeight = sourceHeight * formRatio;
                        
                        pdf.addImage(
                            formImgData,
                            'JPEG',
                            margin,
                            margin,
                            contentWidth,
                            destHeight,
                            undefined,
                            'FAST'
                        );
                        
                        yOffset += contentHeight;
                        pageCount++;
                    }

                    // Agregar página de resultados al final
                    pdf.addPage();
                    const resultsImgData = resultsCanvas.toDataURL('image/jpeg', 0.95);
                    const resultsRatio = contentWidth / resultsCanvas.width;
                    const resultsScaledHeight = resultsCanvas.height * resultsRatio;
                    
                    pdf.addImage(
                        resultsImgData,
                        'JPEG',
                        margin,
                        margin,
                        contentWidth,
                        resultsScaledHeight,
                        undefined,
                        'FAST'
                    );

                    pdf.save('Formulario_Fiscalizacion_Completado.pdf');

                } catch (e) {
                    console.error("Error al generar el PDF:", e);
                } finally {
                    // Restaurar la vista de resultados
                    calculateBtnContainer.style.display = 'block';
                    formPage.classList.add('hidden');
                    resultsPage.classList.remove('hidden');
                    window.scrollTo(0, currentScrollPos);
                    
                    loader.classList.add('hidden');
                    downloadBtn.classList.remove('hidden');
                    backBtn.classList.remove('hidden');
                }
            });
